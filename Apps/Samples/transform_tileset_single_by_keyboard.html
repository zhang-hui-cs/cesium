<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Hello World!</title>
    <script src="../../Build/CesiumUnminified/Cesium.js"></script>
    <style>
        @import url(../../Build/Cesium/Widgets/widgets.css);

        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <script>
        console.log(Cesium);
        const option = {
            viewer: null,
            tilesetParameters: {
                url: "http://localhost:2001/%E6%B9%98%E6%B1%9F%E6%96%B0%E5%8C%BA%E5%9F%8E%E5%B8%82%E8%AE%BE%E8%AE%A1%E5%B9%B3%E5%8F%B0/%E5%9C%B0%E5%9D%97/meixihu/tileset.json",
                modelMatrix: Cesium.Matrix4.fromArray([0.9933820974048085, -0.05921169013565031, 0.0984173983953198, 0, 0.07757388029737741, 0.9777858491060097, -0.1947232045331208, 0, -0.08470124940773618, 0.20106916481479492, 0.9759082381604578, 0, -463.2848653134173, 1149.437345862737, 4471.176438980561, 1]),
                centerPosition: Cesium.Cartesian3.fromDegrees(112.870655, 28.180864),
                centerMatrix: null,
                centerAxisX: null,
                centerAxisY: null,
                centerAxisZ: null,
            },
            arcgisUrl: "http://10.14.3.71:6080/arcgis/rest/services/CityDesignV6/XJXQCSSJPlanMap/MapServer"
        };

        option.viewer = new Cesium.Viewer('cesiumContainer', {
            baseLayerPicker: false,
            fullscreenButton: false,
            homeButton: false,
            sceneModePicker: false,
            selectionIndicator: false,
            timeline: false,
            animation: false,
            navigationHelpButton: false,
            infoBox: false,
            geocoder: false,
            imageryProvider: new Cesium.WebMapTileServiceImageryProvider({
                url: `http://t0.tianditu.gov.cn/img_w/wmts?tk=9d2964079a8920b154e7bebe798f80ca`,
                layer: "img",
                style: "default",
                tileMatrixSetID: "w",
                format: "tiles",
                maximumLevel: 18,
            })
        });

        initial();

        function initial() {
            calcuteAxis();
            loadTileset();
            addScreenSpaceEventHandler();
            onKeyDown();
        }

        function loadTileset() {
            option.viewer.imageryLayers.addImageryProvider(new Cesium.ArcGisMapServerImageryProvider({ url: option.arcgisUrl }));

            option.tileset = option.viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
                url: option.tilesetParameters.url,
                modelMatrix: option.tilesetParameters.modelMatrix
            }));

            option.viewer.flyTo(option.tileset);
        }

        function calcuteAxis() {
            const matrix = option.tilesetParameters.centerMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(option.tilesetParameters.centerPosition);
            option.tilesetParameters.centerAxisX = Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(matrix, 0, new Cesium.Cartesian4()));
            option.tilesetParameters.centerAxisY = Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(matrix, 1, new Cesium.Cartesian4()));
            option.tilesetParameters.centerAxisZ = Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(matrix, 2, new Cesium.Cartesian4()));
        }

        function onKeyDown() {
            document.addEventListener("keydown", event => {
                if (event.keyCode == '38') {
                    // up arrow
                    move(option.tileset, option.tilesetParameters.centerAxisY, 1);
                } else if (event.keyCode == '40') {
                    // down arrow
                    move(option.tileset, option.tilesetParameters.centerAxisY, -1);
                } else if (event.keyCode == '37') {
                    // left arrow
                    move(option.tileset, option.tilesetParameters.centerAxisX, -1);
                } else if (event.keyCode == '39') {
                    // right arrow
                    move(option.tileset, option.tilesetParameters.centerAxisX, 1);
                }
            });
        }

        function addScreenSpaceEventHandler() {
            const handler = new Cesium.ScreenSpaceEventHandler(option.viewer.canvas);
            handler.setInputAction(event => {
                const pt1 = option.viewer.scene.pickPosition(event.position);
                const matrix1 = Cesium.Transforms.eastNorthUpToFixedFrame(pt1);

                const pt2 = Cesium.Cartesian3.fromDegrees(112.843468, 28.180215, 10);
                const matrix2 = Cesium.Transforms.eastNorthUpToFixedFrame(pt2);

                let matrix = new Cesium.Matrix4();
                Cesium.Matrix4.multiply(matrix2, Cesium.Matrix4.inverse(matrix1, matrix), matrix);

                console.log("matrix", Cesium.Matrix4.toArray(matrix));

            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // handler.setInputAction(event => {
            //     if (option.tileset) {
            //         option.tileset.modelMatrix = Cesium.Matrix4.clone(Cesium.Matrix4.IDENTITY);
            //     }
            // }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
        }

        function move(tileset, axis, step) {
            const offset = Cesium.Cartesian3.multiplyByScalar(axis, step, new Cesium.Cartesian3());
            const matrixOffset = Cesium.Matrix4.fromTranslation(offset);

            tileset.modelMatrix = Cesium.Matrix4.multiply(tileset.modelMatrix, matrixOffset, new Cesium.Matrix4());

            console.log("modelMatrix", tileset.modelMatrix);
        }

    </script>
</body>

</html>
